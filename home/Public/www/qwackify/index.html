<!DOCTYPE html>
<html lang="en" height="100vh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extreme Color Explosion Media Player</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- glitch -->
    <link rel="stylesheet" href="../static/css/nuclear.min.css">
    <link rel="stylesheet" href="../static/css/nuke.css">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="stylesheet" href="../static/css/pyscript.css">
    <script src="../static/js/cactus.js"></script>
    <script defer src="../static/js/pyscript.js"></script>
    
    <link rel="stylesheet" href="../static/css/playerContainer.css">
    <link rel="stylesheet" href="../static/css/searchContainer.css"> 
    <!-- playlist -->
    <link rel="stylesheet" href="../static/css/playlistContainer.css">
   <!-- <script defar src="../static/js/playlistButton.js"></script> -->
    <!-- videosplit -->
  <!--  <script defer src="../static/js/videoSplit.js"></script> -->
  <!--  <link rel="stylesheet" href="../static/css/videoSplit.css">   --> 
    <!-- options -->
    <script defer src="../static/js/optionsButton.js"></script>
    <link rel="stylesheet" href="../static/css/optionsList.css">
    
    <script defer src="../static/js/slideButtons.js"></script>
    <link rel="stylesheet" href="../static/css/slideLists.css">

    <script defer src="../static/js/remoteButton.js"></script>
    <link rel="stylesheet" href="../static/css/channelList.css">  
  
    <script defer src="../static/js/trashButton.js"></script>
    <script defer src="../static/js/newsButton.js"></script>
  
    <script defer src="../static/js/keyBindings.js"></script>
    <script defer src="../static/js/playplaylistButton.js"></script>
    <script defer src="../static/js/receiverButtons.js"></script>
    <link rel="stylesheet" href="../static/css/receiverButtons.css"> 
 
    <script defer src="../static/js/volumeSlider.js"></script> 
    <script defer src="../static/js/controls.js"></script>
    <script defer src="../static/js/adbButtons.js"></script>
    <link rel="stylesheet" href="../static/css/remoteButton.css"> 
 
  <!--  <script defer src="../static/js/videoSplit.js"></script> -->
    <link rel="stylesheet" href="../static/css/videoSplit.css">
    <style>
        /* General styling */
        body {
            padding: 0;
          /*  min-height: 100vh;*/
          /*  max-width: 100vw; */
            background-color: none;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            position: relative;
        }

        /* Spectrum canvas behind content */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
        }

        /* Player styling */
        .player-container {
            text-align: center;
            background-color: #222;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 20px rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2;
        }

        /* Album cover */
        .album-cover {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto;
            z-index: 3;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .album-cover img {
            z-index: 3;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Controls */
        .controls {
            transition: transform 0.5s ease, opacity 0.5s ease;
            display: none;
            justify-content: center;
            align-items: center;
            margin-top: 0px;
            gap: 10px; /* Added gap to make space between the buttons */
        } 

        .controls.active {
            display: block; /* Show the active control set */
            transform: translateY(0); /* Reset position for active set */
        }


        .controls button {
            font-family: 'Material Icons';
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            font-size: 36px;
            color: #888;
            cursor: pointer;
        }

        nediaPlayer {
            position: relative;
            z-index: 999;
        }
        video {
            position: relative;
            z-index: 999;
        }

        .controls button:hover {
            color: #ff7bac;
        }
        .controls button:focus {
            outline: none; /* Removes the outline on focus */
        }

        .controls .play {
            font-size: 48px;
            color: #ff7bac;
        }


        /* playlist_controsl = shuffle, playlist, chromecast */
        .icon-row {
            display: flex;
            justify-content: flex-start; /* Align icons to the left */
            align-items: center; /* Vertically center the icons */
            gap: 20px; /* Adds space between the icons, adjust as needed */
            padding: 0px; /* Optional: adds some padding around the icons */
        }

        .icon-row button {
            background: none;
            border: none;
            font-size: 36px; /* Icon size */
            color: #888;
            cursor: pointer;
        }

        .icon-row button:hover {
            color: #ff7bac; /* Optional hover effect */
        }



        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
        }

        .progress-bar div {
            height: 100%;
            width: 0%;
            background: #ff7bac;
            border-radius: 5px;
        }

        /* Time display */
        .time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #888;
        }

        /* Updated hidden class */
        .hidden {
            pointer-events: none;
            opacity: 0;
            transform: translateX(100%);
        }
        
        .control-slide-hidden {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }
        .control-slide-visible {
            transform: translateX(0);
            opacity: 1;
        }


        

        /* Hidden List (initial state) */
        /* Initial hidden state */
        #itemList {
            position: absolute;
            top: calc(65% - 30px); /* Adjust as needed */
            left: calc(20%); /* Adjust based on your layout */
            width: 250px; /* Set full width from the start */
            max-height: 0; /* Start with height 0 */
            overflow: hidden;
            opacity: 0; 
            transform-origin: top; /* Expand from the top */
            transition: opacity 0.3s ease, max-height 0.5s ease; /* Control height transition */
        }
        
        /* Visible state - expand downward */
        #itemList.visible {
            max-height: 300px; /* Final height when fully expanded */
            opacity: 1;
            overflow-y: auto;
        }

        /* Each list item appears on rising */
        @keyframes riseExpand {
            0% {
                transform: scaleY(0); /* Start from no height */
                opacity: 0;
            }
            100% {
                transform: scaleY(1); /* Expand to full height */
                opacity: 1;
            }
        }

        /* Hidden list items initially */
        .list-item {
            color: pink;
            opacity: 0;
            transform: translateY(-10px); /* Position slightly above */
            transition: opacity 0.5s ease, transform 0.5s ease;
            text-align: right;
        }

        /* Show individual list items progressively */
        .list-item.visible {
            color: pink;
            opacity: 1;
            transform: translateY(0); /* Bring the item into place */
            animation: riseExpand 1.5s ease-in-out; /* Apply rising animation */
        }
        
        
        /* Glitch effect and hue animation */
        #glitchbox {
            animation: glitch 3s linear infinite;
        }

        @keyframes glitch {
            0% { filter: none; }
            1% { filter: url(#f1); }
            5% { filter: none; }
            7% { filter: url(#f1); }
            8% { filter: none; }
            10% { filter: url(#f1); }
            13% { filter: none; }
            100% { filter: none; }
        }

        
        .list-item {
            margin: 2px;
            font-size: 10px;
            padding: 2px;
            height: 35px;
            display: inline-block; 
        }
        .list-item img {
            
        }
        .list-item span {
            display: block;
            text-align: left;
            margin-top: 0px;
        }
        
        
        .list-item img { 
            width: 30px;
            height: auto;
            margin-right: 0px;
            filter: invert(100%); /* Inverts colors of the images */
        }


        #huebox {
            animation: hueshift 10s ease-in-out infinite;
        }

        @keyframes hueshift {
            0%, 50% { filter: hue-rotate(0deg); }
            60% { filter: hue-rotate(360deg); }
            70% { filter: hue-rotate(0deg); }
            80% { filter: hue-rotate(360deg); }
            90% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
                
    </style>             

</head>
<body>
    

    <!-- Add New TV Modal -->
    <div id="tvModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('tvModal')">&times;</span>
            <h2>Add New TV</h2>
            <form id="addTvForm">
                <label for="tv-ip">IP Address:</label><br>
                <input type="text" id="tv-ip" name="ip" required><br><br>
                <label for="tv-name">Name:</label><br>
                <input type="text" id="tv-name" name="name" required><br><br>
                <label for="tv-default">Default (Optional):</label><br>
                <input type="text" id="tv-default" name="default"><br><br>
                <button type="button" onclick="submitTvForm()">Add TV</button>
            </form>
        </div>
    </div>

    <!-- Add New Channel Modal -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('channelModal')">&times;</span>
            <h2>Add New Channel</h2>
            <form id="addChannelForm">
                <label for="channel-id">ID:</label><br>
                <input type="text" id="channel-id" name="id" required><br><br>
                <label for="channel-name">Name:</label><br>
                <input type="text" id="channel-name" name="name" required><br><br>
                <label for="channel-url">URL:</label><br>
                <input type="text" id="channel-url" name="url" required><br><br>
                <label for="channel-icon">Icon URL (Optional):</label><br>
                <input type="text" id="channel-icon" name="icon_url"><br><br>
                <button type="button" onclick="submitChannelForm()">Add Channel</button>
   
            </form>
        </div>
    </div>

    <!-- Organize Channel Modal -->
    <div id="organizeChannelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('organizeChannelModal')">&times;</span>
            <h2>Organize Channels</h2>
            <div id="channelList">
                <!-- Dynamic list of channels will be populated here -->
            </div>
            <button type="button" onclick="saveChannelOrder()">Save Order</button>
        </div>
    </div>


    <!-- Add Podcast Modal -->
    <div id="podcastModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('podcastModal')">&times;</span>
            <h2>Add Podcast</h2>
        
            <!-- Form to add a new podcast -->
            <form action="/api/podcasts/add" method="post">
                <label for="name">Podcast Name:</label><br>
                <input type="text" id="name" name="name" required><br><br>

                <label for="rss_link">RSS Link:</label><br>
                <input type="url" id="rss_link" name="rss_link" required><br><br>

                <!-- The path will be generated based on the podcast name -->
                <button type="submit">Add Podcast</button>
            </form>
        </div>
    </div>

    <!-- Add Newscast Item Modal -->
    <div id="newscastModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newscastModal')">&times;</span>
            <h2>Add Newscast Item</h2>
            <p>Coming soon!</p>
        </div>
    </div>



<!-- Glitch effect from HTML 1 -->
<svg height="0">
    <filter id="f1">
        <feturbulence type="fractalNoise" baseFrequency="0 0.15" numOctaves="1" result="warp"></feturbulence>
        <fedisplacementmap xChannelSelector="R" yChannelSelector="G" scale="30" in="SourceGraphic" in2="warp"></fedisplacementmap>
        <fecolormatrix type="matrix" result="red_" values="4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0"></fecolormatrix>
        <feoffset in="red_" dx="2" dy="0" result="red"></feoffset>
        <fecolormatrix type="matrix" in="SourceGraphic" result="blue_" values="0 0 0 0 0 0 3 0 0 0 0 0 10 0 0 0 0 1 0"></fecolormatrix>
        <feoffset in="blue_" dx="-3" dy="0" result="blue"></feoffset>
        <feblend mode="screen" in="red" in2="blue"></feblend>
    </filter>
</svg>
<!-- Hidden Right Side Lists -->
<ul id="musicList" class="hidden"></ul>
<ul id="tvList" class="hidden"></ul>
<ul id="movieList" class="hidden"></ul>
<ul id="deviceList"></ul>
<!-- Hidden Podcast List -->
<ul id="podcastList"></ul>
<!-- ---------------- -->
<!-- ---------------- -->
<!-- OPTIONS LIST HIDDEN -->
<ul id="optionsList">
    <li class="options-item" onclick="openModal('tvModal')">Add new TV</li>
    <li class="options-item" onclick="openModal('channelModal')">Add new channel</li>
    <li class="options-item" onclick="openModal('podcastModal')">Add new Podcast</li>
    <li class="options-item" onclick="openModal('organizeChannelModal')">Organize channel</li>
    <li class="options-item" onclick="openModal('newscastModal')">Add newscast item</li>
    <li class="options-item" onclick="deletePlayedNews()">Delete played news</li>
</ul>
<!-- -------------- >
<!-- -------------- >
<!-- Hidden List -->
<ul id="itemList"></ul>
    <!-- Dynamically loaded channels will appear here -->
<!-- Spectrum canvas for visualization -->
<canvas id="spectrumCanvas"></canvas>


<!-- Player Content -->
<div id="search-ontainer">
    <div id="huebox">
        <div id="glitchbox">
            <center>
                <!-- search box -->
                <div class="search-input" id="search-container">
                    <input type="text" id="search-input" placeholder="Search..." />
                    
                </div>
            </center>    
        </div>
    </div>
</div>

<!-- Player Content -->
<div id="maincontent">
    <div id="huebox">
        <div id="glitchbox">
            <center>
                <!-- Media Player -->
                <div class="player-container" id="playerContainer">

                <!--    <video id="video" height="360" style="display: none;">
                        <source id="videoSource" src="" type="video/mp4">
                        Your browser does not support the video element.
                    </video> -->


                    <!-- Top part of the player (album cover, controls) -->
                    <div class="player-top" id="playerTop">
                  
                        <div class="controls" style="display: flex; justify-content: space-between; width: 100%;">
                            <div class="left-column" style="display: flex; flex-direction: column;">
                                <button id="optionsButton" class="material-icons">settings</button>
                                <button id="newsButton" class="material-icons">newspaper</button>
                                <button id="podcastButton" class="material-icons">podcasts</button>
                               <!-- <i class="material-icons">music_note</i> -->
                                <button id="spotifyButton" class="state_button" onclick="toggleButton('spotifyButton')">
                                    <img src="../static/spotify-green.png">
                                </button> 
                                
  
                            </div>
                             
                           <!-- <div class="album-cover">
                                <img src="../static/qwackify.png" alt="Album cover" style="width: 150px; height: 150px;">
                            </div> -->
                            
                            <!-- ALBUM COVER -->
                            <!-- Default Cover -->
                            <div id="defaultAlbumCover" class="album-cover">
                                <img src="../static/qwackify.png" alt="Album cover" style="width: 150px; height: 150px;">
                            </div>
                            <!-- Spotify Album -->
                            <div id="spotifyAlbumCover" class="album-cover">
                                <img src="../static/qwackify.png" alt="Album cover" style="width: 150px; height: 150px;">
                            </div>
                            <!-- ADB Album -->
                            <div id="adbAlbumCover" class="album-cover">
                                <img src="../static/qwackify.png" alt="Album cover" style="width: 150px; height: 150px;">
                            </div>
                            
                            
                            <div class="controls" style="display: flex; justify-content: center;">
                                <button id="heartButton" class="material-icons">favorite</button>
                            </div>
                            <div class="right-column" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                                <button id="musicButton" class="material-icons">music_note</button>
                                <button id="movieButton" class="material-icons">movie</button>
                                <button id="tvButton" class="material-icons">tv</button>
                                <button id="adbButton" class="state_button" onclick="toggleButton('adbButton')">
                                 <!--   <img src="http://clipart-library.com/images_k/youtube-logo-transparent-white/youtube-logo-transparent-white-16.png" alt="YouTube Logo"> -->
                                    <img src="../static/android-green.png">
                                </button> 
                                
                                
                            </div>
                        </div>
                    </div>
                    <video id="video" height="360" style="display: none; z-index: 1000;">
                        <source id="videoSource" src="" type="video/mp4">
                        Your browser does not support the video element.
                    </video> 


                    <!-- Track Info (below album cover) -->
                 <!--   <div class="track-info" style="text-align: center;">
                        <h2 id="trackTitle">Duck Song</h2>
                        <p id="trackInfo">A fun song about ducks</p>
                    </div> -->
                    
                    <!-- <div id="nowPlaying">Loading...</div> -->
                    <!-- NOW-PLAYING -->
                    <!-- Default Now PLaying -->
                    <div id="defaultTrackInfo" class="track-info"></div>
                    <!-- Spotify Now playing -->
                    <div id="spotifyTrackInfo" class="track-info">Loading Spotify...</div>
                    <!-- ADB Now PLaying -->
                 <!--   <div id="adbTrackInfo" class="track-info">..</div> -->
                    <div id="adbTrackInfo" class="track-info"></div>
                   <!-- <div class="volume-slider">
                        <input type="range" id="volumeControl" min="0" max="100" value="50" oninput="updateVolume()" />
                        <span class="volume-label"></span>
                    </div> -->
                    <!-- VOLUME SLIDER -->
                    <!-- Default Volume -->
                    <div id="defaultVolumeControl" class="volume-slider">
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="updateVolume()" />
                        
                    </div>
                    <!-- Spotify Volume -->
                    <div id="spotifyVolumeControl" class="volume-slider">
                        <input type="range" id="spotifyVolumeControl" min="0" max="100" value="50" oninput="updateVolume()" />
                    </div>
                    <!-- ADB Volume  -->
                    <div id="adbVolumeControl" class="volume-slider">
                        <input type="range" id="adbVolumeSlider" min="0" max="100" value="50" oninput="updateadbVolume()" />
                    </div>

                    
                  <!--  <div id="trackTitle">Track Title</div>
                    <div id="trackInfo">Audio Track</div -->
                    <!-- Glowing Box (initially hidden) -->
                    <div class="split-box" id="glowingBox"></div>
                    <!-- Bottom part of the player (controls, progress bar) -->
                    <div class="player-bottom" id="playerBottom">
                    <!---    <div class="controls" style="display: flex; justify-content: center;">
                            <button id="shuffle" class="state_button" onclick="toggleSingleButton('shuffle')"><span class="material-icons">shuffle</span></button>
                            <button id="prevButton"><span class="material-icons">skip_previous</span></button>
                            <button id="playPauseButton" class="state_button"><span class="material-icons">play_circle_filled</span></button>
                            <button id="nextButton"><span class="material-icons">skip_next</span></button>
                            <button id="repeat" class="state_button" onclick="toggleSingleButton('repeat')"><span class="material-icons">repeat</span></button>
                       </div> -->
                       
                        <!-- here -->
                        <div id="defaultControls" class="controls active">
                            <button id="shuffle" class="state_button" onclick="toggleSingleButton('shuffle')"><span class="material-icons">shuffle</span></button>
                            <button id="prevButton"><span class="material-icons">skip_previous</span></button>
                            <button id="playPauseButton" class="state_button"><span class="material-icons">play_circle_filled</span></button>
                            <button id="nextButton"><span class="material-icons">skip_next</span></button>
                            <button id="repeat" class="state_button" onclick="toggleSingleButton('repeat')"><span class="material-icons">repeat</span></button>
                        </div>

                        <div id="spotifyControls" class="controls">
                            <button id="spotifyshuffle" class="state_button" onclick="toggleSingleButton('spotifyshuffle')"><span class="material-icons">shuffle</span></button>
                            <button id="spotifyprevButton"><span class="material-icons">skip_previous</span></button>
                            <button id="spotifyplayPauseButton" class="state_button"><span class="material-icons">play_circle_filled</span></button>
                            <button id="spotifynextButton"><span class="material-icons">skip_next</span></button>
                            <button id="spotifyrepeat" class="state_button" onclick="toggleSingleButton('spotifyrepeat')"><span class="material-icons">repeat</span></button>
                        </div>

                        <div class="controls" id="adbControls">
                            <button id="adbreconnect" class="state_button" onclick="toggleSingleButton('adbreconnect')">
                                <span class="material-icons">sync</span>
                            </button>
                            <button id="adbprevButton"><span class="material-icons">skip_previous</span></button>
                            <button id="adbplayPauseButton" class="state_button"><span class="material-icons">play_circle_filled</span></button>
                            <button id="adbnextButton"><span class="material-icons">skip_next</span></button>
                            <button id="adbpower" class="state_button" onclick="toggleSingleButton('adbpower')">
                                <span class="material-icons">power_settings_new</span>
                            </button>
                        </div>
                      <!--  <video id="video" height="360" style="display: none;">
                            <source id="videoSource" src="" type="video/mp4">
                            Your browser does not support the video element.
                        </video> -->


                        </div>
                        <!-- Progress Bar -->
                        <div class="progress-bar" style="width: 100%; margin-top: 10px;">
                            <div id="progress"></div>
                        </div>
                  

                        <!-- Time Info -->
                        <div class="time" style="display: flex; justify-content: space-between; width: 100%; margin-top: 5px;">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                        <!-- Playlist, Shuffle, Heart Controls -->
                        <div class="controls" style="display: flex; justify-content: center; gap: 20px;">  
                            <button id="remoteButton" class="state_button" onclick="toggleSingleButton('remoteButton')">
                                <img src="../static/img/remote.png" height="24" width="24">
                            </button>
                            <button id="playplaylistButton" class="material-icons" style="background: none; border: none;">playlist_play</button>
                             
                            <button id="playlistButton" class="material-icons">playlist_add</button>
                            <button id="castButton" class="material-icons">cast</button>   
                            <button id="playlistTrashButton" style="background: none; border: none;">
                                <img src="../static/playlist-trash.png" height="18" width="18">
                            </button>
                        </div>

                        <!-- Playlist Container (hidden by default) -->
                        <div id="playlistContainer" class="playlist-container">
                            
                            <div class="playlist-items">
                            <!-- Playlist items will be loaded here -->
                            </div>
                        </div>                


                        <!-- Remote Control Box -->
                        <div id="remote-control-container" class="hidden">
                            <!-- Placeholder for remote control content -->
                            <p style="color: white; text-align: center;">Remote Control</p>
                        </div>
                    </div>        
                </div>
            </center>
        </div>
    </div>
</div>
          
<!-- Audio element -->
<audio id="audio">
    <source id="audioSource" src="" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>
<video id="video" height="360" style="display: none;">
    <source id="videoSource" src="" type="video/mp4">
    Your browser does not support the video element.
</video>

<!-- JS for audio, playlist toggle, and spectrum control -->
<!-- JS for audio, playlist toggle, and spectrum control -->


<script>
    const playlistUrl = 'http://192.168.1.28:6999/api/playlist/';
    const playlistElement = document.getElementById('playlistContainer');
    const mediaPlayer = document.getElementById('video');
    const audioPlayer = document.getElementById('audio');
    const audioElement = document.getElementById('audio');
    const videoElement = document.getElementById('video');
    const playPauseButton = document.getElementById('playPauseButton');
    const playlistButton = document.getElementById('playlistButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const shuffleButton = document.getElementById('shuffle');
    const repeatButton = document.getElementById('repeat');
    const playerContainer = document.getElementById('playerContainer');
    const playlistContainer = document.getElementById('playlistContainer');
    const playlistItemsContainer = document.querySelector('.playlist-items');
    const spectrumCanvas = document.getElementById('spectrumCanvas');
    const canvasContext = spectrumCanvas.getContext('2d');
    const progressBar = document.getElementById('progress');
    const currentTimeElement = document.getElementById('currentTime');
    const durationElement = document.getElementById('duration');
    let audioContext, analyser, sourceNode;
    let spectrumData;
    let playlistVisible = false;
    let currentTrack = 0;
    let playlist = [];
    let currentElement = null;
    let currentTrackPath = ""; // Global variable for the current track's file path
    let currentPlayer = null;

    function playPause() {
        if (currentPlayert.paused) {
            currentPlayer.play();
        } else {
            currentPlayer.pause();
        }
    }



    // Fetch the playlist and populate the UI
    async function fetchPlaylist() {
        try {
            const response = await fetch(playlistUrl);
            const data = await response.json();
            playlist = data.playlist;
            playlistItemsContainer.innerHTML = ''; // Clear existing items
            playlist.forEach((url, index) => {
                const item = document.createElement('div'); // Create div instead of li
                item.classList.add('playlist-item'); // Add class for styling
                item.textContent = url.split('/').pop(); // Get the file name
                item.addEventListener('click', () => playMedia(index)); // Set up event listener
                playlistItemsContainer.appendChild(item); // Append item to the container
            });
        } catch (error) {
            console.error('Error fetching playlist:', error);
        }
    }

    function playMedia(index) {
        const url = playlist[index];
        const isVideo = url.includes('mp4') || url.includes('webm');
        // Define unsupported formats in an array
        const unsupportedFormats = ['.mkv', '.avi', '.mov', '.flv'];
        // Check if the file has an unsupported format

      //  const isUnsupportedFormat = unsupportedFormats.some(ext => url.endsWith(ext));
        // Check if the file has an unsupported format
        const isUnsupportedFormat = unsupportedFormats.some(ext => url.endsWith(ext)) || url.startsWith("http://lol.");


    //    const currentMediaDiv = document.getElementById('currentMedia');
        // If the file is an unsupported format, transcode it to MP4
        if (isUnsupportedFormat) {
            const videoUrl = `http://192.168.1.181:7999/transcode-video/?url=${encodeURIComponent(url)}`;
            mediaPlayer.style.display = 'block';
            audioPlayer.style.display = 'none';
            mediaPlayer.src = videoUrl;  // Set the transcoded URL to mediaPlayer
            mediaPlayer.play();
            currentPlayer = mediaPlayer;
        } else if (isVideo) {
            // For MP4 or WebM files, play them directly
            mediaPlayer.style.display = 'block';
            audioPlayer.style.display = 'none';
            mediaPlayer.src = url;
            mediaPlayer.play();
            currentPlayer = mediaPlayer;
   //         currentMediaDiv.textContent = `Currently Playing: ${url.split('/').pop()}`;
        } else {
            // For audio files, play them on audioPlayer
            mediaPlayer.style.display = 'none';
            audioPlayer.style.display = 'block';
            audioPlayer.src = url;
            audioPlayer.play();
            currentPlayer = audioPlayer;
   //         currentMediaDiv.textContent = `Currently Playing: ${url.split('/').pop()}`;
        }

        // Template the URL for display
        let displayUrl = url;
        if (url.startsWith("https://qwackify.duckdns.org/")) {
            const parts = url.split("/");
            if (parts.length > 5) {
                displayUrl = parts.slice(4).join("/").replace("/", " - ");
            }
        }

        // Update the displayed track info
        document.getElementById("defaultTrackInfo").innerText = "Playing: " + displayUrl;


        currentTrackIndex = index;
        // updatePlayerControls();  // Uncomment if needed for controls update
    }

    // Play selected media
//    function playMedia(index) {
//        const url = playlist[index];
//        const isVideo = url.includes('mp4') || url.includes('webm');
//        
//        if (isVideo) {
//            mediaPlayer.style.display = 'block';
//            audioPlayer.style.display = 'none';
//            mediaPlayer.src = url;
//            mediaPlayer.play();
//            currentPlayer = mediaPlayer;
//        } else {
//            mediaPlayer.style.display = 'none';
//           audioPlayer.style.display = 'block';
//            audioPlayer.src = url;
//            audioPlayer.play();
//            currentPlayer = audioPlayer;
//        }

//        currentTrackIndex = index;
//      //  updatePlayerControls();
//    }

    playlistButton.addEventListener('click', () => {
        playlistVisible = !playlistVisible;
        playlistContainer.classList.toggle('open', playlistVisible);
        playlistButton.textContent = playlistVisible ? 'playlist_remove' : 'playlist_add';
    });





   // function setupAudioContext() {
   //     if (!audioContext) {
   //         audioContext = new (window.AudioContext || window.webkitAudioContext)();
   //         analyser = audioContext.createAnalyser();
   //         analyser.fftSize = 256;
   //         spectrumData = new Uint8Array(analyser.frequencyBinCount);
   //     }
  //  }

  //  function connectAnalyser(element) {
  //      if (sourceNode) sourceNode.disconnect();
  //      sourceNode = audioContext.createMediaElementSource(element);
  //      sourceNode.connect(analyser);
 //       analyser.connect(audioContext.destination);
 //       updateSpectrum();
 //   }
    

    function updateSpectrum() {
        if (!analyser || audioContext.state !== 'running') return;
        analyser.getByteFrequencyData(spectrumData);
        canvasContext.clearRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);

        const barWidth = spectrumCanvas.width / analyser.frequencyBinCount;
        for (let i = 0; i < analyser.frequencyBinCount; i++) {
            const barHeight = spectrumData[i] * 1.5;
            canvasContext.fillStyle = `rgb(${barHeight + 100},${255 - barHeight},${barHeight / 2})`;
            canvasContext.fillRect(i * barWidth, spectrumCanvas.height - barHeight, barWidth, barHeight);
        }
        requestAnimationFrame(updateSpectrum);
    }

 
    function updateCurrentTrackDisplay(track) {
        console.log("Current Track:", track); // Log the current track for debugging
        document.getElementById('currentTrackDisplay').textContent = `Current Track: ${track.split('/').pop()}`; // Display the track name
    }

    // Pause and Play Toggle for the Current Track in Playlist
    playPauseButton.addEventListener('click', () => {
        if (!currentPlayer) return; // Ensure a track is loaded
        if (currentPlayer.paused) {
            currentPlayer.play();
            playPauseButton.textContent = 'pause_circle_filled'; // Update icon to pause
        } else {
            currentPlayer.pause();
            playPauseButton.textContent = 'play_circle_filled'; // Update icon to play
        }
    });

    nextButton.addEventListener('click', playNext);
    prevButton.addEventListener('click', playPrevious);

    shuffleButton.addEventListener('click', () => {
        playlist.sort(() => Math.random() - 0.5);
        displayPlaylistItems();
    });

    repeatButton.addEventListener('click', () => {
        currentElement.loop = !currentElement.loop;
        repeatButton.style.color = currentElement.loop ? '#ff7bac' : '#888';
    });

    function updateProgress(element) {
        progressBar.style.width = `${(element.currentTime / element.duration) * 100}%`;
        currentTimeElement.textContent = formatTime(element.currentTime);
        durationElement.textContent = formatTime(element.duration);
    }

    audioElement.addEventListener('timeupdate', () => updateProgress(audioElement));
    videoElement.addEventListener('timeupdate', () => updateProgress(videoElement));

    function formatTime(time) {
        const minutes = Math.floor(time / 60);
        const seconds = Math.floor(time % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

 //   async function fetchPlaylist() {
 //       try {
 //           const response = await fetch('/api/playlist');
 //           const data = await response.json();
 //           playlist = data.playlist;
 //           displayPlaylistItems();
 //           if (playlist.length > 0) playTrack(currentTrack);
 //       } catch (error) {
 //           console.error("Error loading playlist:", error);
//        }
 //   }

  //  function displayPlaylistItems() {
 //       playlistItemsContainer.innerHTML = '';
  //      playlist.forEach((track, index) => {
 //           const item = document.createElement('div');
 //           item.classList.add('playlist-item');
 //           item.textContent = track.split('/').pop();
 //           item.addEventListener('click', () => playTrack(index));
 //           playlistItemsContainer.appendChild(item);
 //       });
//    }

 //   function playTrack(index) {
 //       if (index < 0 || index >= playlist.length) return; // Check for valid index
 //       currentTrack = index; // Update the index of the current track
//
//        const track = playlist[index]; // Get the current track file path
//        currentTrackPath = track; // Update the global variable with the current track's file path

 //       currentElement = track.endsWith('.mp3') || track.endsWith('.wav') ? audioElement : videoElement; // Determine the media element

  //      currentElement.src = track; // Set the source for the media element
 //       currentElement.load(); // Load the new track
 //       currentElement.play(); // Start playing the track

 //       connectAnalyser(currentElement); // Connect the audio analyser
  //      playPauseButton.textContent = 'pause_circle_filled'; // Update play/pause button text

        // Update the UI with the track title and info
  //      document.getElementById('trackTitle').textContent = track.split('/').pop(); // Extract and display the track name
  //      document.getElementById('trackInfo').textContent = track.endsWith('.mp3') ? "Audio Track" : "Video Track"; // Display type of track

  //      pdateCurrentTrackDisplay(track); // Pass the current track to the display update function
 //   }



  //  function playTrack(index) {
 //       if (index < 0 || index >= playlist.length) return;
 //       currentTrack = index;
 //       const track = playlist[index];
 //       currentElement = track.endsWith('.mp3') || track.endsWith('.wav') ? audioElement : videoElement;
 //       currentElement.src = track;
 //       currentElement.load();
 //       currentElement.play();
 //       connectAnalyser(currentElement);
 //       playPauseButton.textContent = 'pause_circle_filled';
 //       document.getElementById('trackTitle').textContent = track.split('/').pop();
 //       document.getElementById('trackInfo').textContent = track.endsWith('.mp3') ? "Audio Track" : "Video Track";
 //       updateCurrentTrackDisplay(); // Update the display
 //   } 

    
    function playNext() {
        // Increment the index to the next track, wrap around if at end of playlist
        currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
        playMedia(currentTrackIndex);
    }

    function playPrevious() {
        // Decrement the index to the previous track, wrap around if at start of playlist
        currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
        playMedia(currentTrackIndex);
    }

    function toggleSingleButton(buttonId) {
        const button = document.getElementById(buttonId);
        button.classList.toggle('active'); // Toggles on/off without affecting other buttons
    }
    
    
    
    // Trogger action on video playback 
//    mediaPlayer.addEventListener('play', playStarted);
    // Trigger action BEFORE video playback
//    mediaPlayer.addEventListener('waiting', beforePlay);   

    mediaPlayer.addEventListener('ended', playNext);
    audioPlayer.addEventListener('ended', playNext);

    fetchPlaylist();
   // setInterval(fetchPlaylist, 30000);  // Refresh playlist every 30 seconds

    // Function to update volume for both audioPlayer and mediaPlayer
    function updateVolume() {
        const volumeSlider = document.getElementById("volumeSlider");
        const volumeLevel = volumeSlider.value / 100;  // Scale to 0 - 1 for volume

        // Set volume for both audioPlayer and mediaPlayer
        audioPlayer.volume = volumeLevel;
        mediaPlayer.volume = volumeLevel;

        // Optionally update the volume label display
//        document.querySelector(".volume-label").innerText = `Volume: ${volumeSlider.value}%`;
    }


    

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

   
    // When mediaPlayer is waiting (buffering or about to start), remove 'player-split'
    mediaPlayer.addEventListener('play', () => {
    //    mediaPlayer.style.visibility = 'hidden';
        mediaPlayer.pause();    
        playerContainer.classList.add('player-split');
  //      playerContainer.classList.add('fall-right');
        setTimeout(() => {
    //        playerContainer.classList.remove('player-split');
       //     mediaPlayer.play(); 
            playerContainer.classList.add('fall-right');
            mediaPlayer.classList.add('fall-left');
      //      mediaPlayer.classList.add('scale-up');
        }, 2200); // 3 seconds

        // Step 2: After 500ms (fall animation duration), apply player-split class for the split animation
        setTimeout(() => {
          //  playerContainer.classList.remove('fall-right'); // Remove the fall effect
            mediaPlayer.play();
            // Apply slide-down animation to controls
            document.getElementById('defaultControls').classList.add('slide-down');
            document.getElementById('spotifyControls').classList.add('slide-down');
            document.getElementById('adbControls').classList.add('slide-down');
            // Apply slide-down animation to volume sliders
            document.getElementById('adbVolumeControl').classList.add('slide-down');
            document.getElementById('spotifyVolumeControl').classList.add('slide-down');
            document.getElementById('defaultVolumeControl').classList.add('slide-down');
       //     mediaPlayer.classList.add('scale-up'); // Remove the fall effect
        }, 3100); // Delay matches fallRight animation duration
      
     //   setTimeout(() => {
//            mediaPlayer.style.visibility = 'visible';
     //       mediaPlayer.play();
    //        console.log("Executed after 3 seconds");
    //    }, 3100); // 3 seconds
    }, { once: true });

    // When audioPlayer is waiting (buffering or about to start), add 'player-split'
    audioPlayer.addEventListener('play', () => {
        playerContainer.classList.remove('player-split');
        playerContainer.classList.remove('fall-right'); 
        console.log("Added player-split during audioPlayer waiting...");
    });


</script>

</body>
</html>
