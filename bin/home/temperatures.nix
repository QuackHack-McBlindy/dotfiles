# dotfiles/bin/home/indoorTemp.nix ‚Æû https://github.com/quackhack-mcblindy/dotfiles
{ # ü¶Ü says ‚Æû simplified zigbee temperature sensor checking.
  self,
  lib,
  config,
  pkgs,
  cmdHelpers,
  ...
} : let # ü¶Ü says ‚Æû configuration directory for diz module
  zigduckDir = "/home/" + config.this.user.me.name + "/.config/zigduck";
  # ü¶Ü says ‚Æû findz da mosquitto host
  sysHosts = lib.attrNames self.nixosConfigurations;
  mqttHost = let
    sysHosts = lib.attrNames self.nixosConfigurations;
    mqttHosts = lib.filter (host:
      let cfg = self.nixosConfigurations.${host}.config;
      in cfg.services.mosquitto.enable or false
    ) sysHosts;
  in
    if mqttHosts != [] then lib.head mqttHosts else null;

  # ü¶Ü says ‚Æû get MQTT broker IP (fallback to localhost)
  mqttHostIp = if mqttHost != null
    then self.nixosConfigurations.${mqttHost}.config.this.host.ip or "127.0.0.1"
    else "127.0.0.1";

  # ü¶Ü says ‚Æû define Zigbee devices here yo 
  zigbeeDevices = config.house.zigbee.devices;

  # ü¶Ü says ‚Æû Filter to only include light devices
  lightDevices = lib.filterAttrs (_: device: device.type == "light") zigbeeDevices;
 
  # ü¶Ü says ‚Æû case-insensitive device matching
  normalizedDeviceMap = lib.mapAttrs' (id: device:
    lib.nameValuePair (lib.toLower device.friendly_name) device.friendly_name
  ) zigbeeDevices;

  # ü¶Ü says ‚Æû Group devices by room
  roomDevicesMap = let
    grouped = lib.groupBy (device: device.room) (lib.attrValues zigbeeDevices);
  in lib.mapAttrs (room: devices: 
      map (d: d.friendly_name) devices
    ) grouped;

  # ü¶Ü says ‚Æû All devices list for 'all' area
  allDevicesList = lib.attrValues normalizedDeviceMap;

  # ü¶Ü says ‚Æû device validation list
  deviceList = builtins.attrNames normalizedDeviceMap;

  # ü¶Ü says ‚Æû Get Zigbee configuration
  zigbeeCfg = if mqttHost != null
    then self.nixosConfigurations.${mqttHost}.config.services.zigbee2mqtt.settings or {}
    else {};

  # ü¶Ü says ‚Æû Precompute device and group mappings
  devicesSet = zigbeeCfg.devices or {};
  groupsSet = zigbeeCfg.groups or {};

  # ü¶Ü says ‚Æû Room bash map with only lights, using | as separator
  roomBashMap = lib.mapAttrs' (room: devices:
    lib.nameValuePair room (lib.concatStringsSep "|" devices)
  ) roomDevicesMap;

  # ü¶Ü says ‚Æû All devices as a pipe-separated string
  allDevicesStr = lib.concatStringsSep "|" allDevicesList;
in { 
  yo.scripts.temperatures = {
    description = "Get all temperature values from sensors and return a average value.";
    category = "üõñ Home Automation";     
    code = ''
      ${cmdHelpers}
      STATE_DIR="${zigduckDir}"
      STATE_FILE="$STATE_DIR/state.json"
      MQTT_HOST="${mqttHost}"
      TEMP=$(ssh "$MQTT_HOST" cat $STATE_FILE | jq -r '.. | objects | .temperature? | select(. != null and . != "null") | tonumber' $STATE_FILE | awk '{sum += $1; count++} END {if (count > 0) print sum / count; else print "No temperatures found"}')
      dt_info "$TEMP"
      if_voice_say "Medeltemperaturen inomhus √§r: $TEMP"
    '';
    voice = {
      priority = 3;
      sentences = [ 
        "hur varmt √§r det (inne|inomhus)"
        "vad √§r det f√∂r (temp|temperatur) (inne|inomhus)"
        "hur varmmt √§r det inne"
      ];  
    };
    
  };}  
    
